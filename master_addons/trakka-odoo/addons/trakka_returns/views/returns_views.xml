<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>

    <!-- ========================= -->
    <!-- Return Case: LIST + FORM  -->
    <!-- ========================= -->

    <record id="view_trakka_return_case_tree" model="ir.ui.view">
      <field name="name">trakka.return.case.tree</field>
      <field name="model">trakka.return.case</field>
      <field name="arch" type="xml">
        <tree string="Return Cases">
          <field name="name"/>
          <field name="state"/>
          <field name="sale_order_id"/>
          <field name="partner_id"/>
          <field name="policy_id"/>
          <field name="reason"/>
          <field name="subtotal_amount"/>
          <field name="fee_amount"/>
          <field name="refund_amount"/>
          <field name="reverse_picking_id"/>
          <field name="refund_move_id"/>
          <field name="company_id"/>
          <field name="create_date"/>
        </tree>
      </field>
    </record>

    <record id="view_trakka_return_case_form" model="ir.ui.view">
      <field name="name">trakka.return.case.form</field>
      <field name="model">trakka.return.case</field>
      <field name="priority">99</field>
      <field name="arch" type="xml">
        <form string="Return Case">
          <!-- expose state for header logic -->
          <field name="state" invisible="1"/>

          <header>
            <!-- Odoo 17: use inline pythonic expressions on attributes -->
            <button name="action_approve"
                    type="object"
                    string="Approve"
                    class="oe_highlight"
                    invisible="(not id) or (state != 'draft')"/>

            <button name="action_reverse_picking_and_credit"
                    type="object"
                    string="Reverse &amp; Credit"
                    invisible="(not id) or (state not in ('approved','reversed'))"/>

            <button name="action_cancel"
                    type="object"
                    string="Cancel"
                    invisible="(not id) or (state in ('refunded','cancelled'))"/>

            <field name="state"
                   widget="statusbar"
                   statusbar_visible="draft,approved,reversed,refunded,cancelled"/>
          </header>

          <sheet>
            <group>
              <group>
                <field name="name" readonly="1"/>
                <field name="company_id"
                       groups="trakka_ops.trakka_group_admin,trakka_ops.trakka_group_finance"/>
                <field name="sale_order_id" required="1"/>
                <field name="partner_id" readonly="1"/>
                <field name="picking_id" required="1"/>
                <field name="invoice_id" required="1"/>
                <field name="escrow_id"/>
              </group>
              <group>
                <field name="policy_id" required="1"/>
                <field name="reason" required="1"/>
                <field name="currency_id"
                       groups="trakka_ops.trakka_group_admin,trakka_ops.trakka_group_finance"/>
                <field name="subtotal_amount" readonly="1"/>
                <field name="allow_overrides_effective" readonly="1"/>

                <!-- when overrides NOT allowed, show computed fee/refund -->
                <field name="fee_amount" readonly="1" invisible="allow_overrides_effective"/>
                <field name="refund_amount" readonly="1" invisible="allow_overrides_effective"/>

                <!-- when overrides allowed, show override inputs -->
                <field name="fee_override" invisible="not allow_overrides_effective"/>
                <field name="refund_override" invisible="not allow_overrides_effective"/>
              </group>
            </group>

            <group string="Artifacts">
              <field name="reverse_picking_id" readonly="1"/>
              <field name="refund_move_id" readonly="1"/>
            </group>

            <group string="Approval">
              <field name="approved_by" readonly="1"/>
              <field name="approved_on" readonly="1"/>
              <field name="policy_snapshot" readonly="1"/>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <!-- Search view -->
    <record id="view_trakka_return_case_search" model="ir.ui.view">
      <field name="name">trakka.return.case.search</field>
      <field name="model">trakka.return.case</field>
      <field name="arch" type="xml">
        <search string="Search Return Cases">
          <field name="name"/>
          <field name="sale_order_id"/>
          <field name="partner_id"/>
          <field name="policy_id"/>
          <field name="reason"/>
          <filter string="Draft" name="state_draft" domain="[('state','=','draft')]"/>
          <filter string="Approved" name="state_approved" domain="[('state','=','approved')]"/>
          <filter string="Reversed" name="state_reversed" domain="[('state','=','reversed')]"/>
          <filter string="Refunded" name="state_refunded" domain="[('state','=','refunded')]"/>
          <filter string="Cancelled" name="state_cancelled" domain="[('state','=','cancelled')]"/>
          <group expand="0" string="Group By">
            <filter string="Policy" name="grp_policy" context="{'group_by': 'policy_id'}"/>
            <filter string="State" name="grp_state" context="{'group_by': 'state'}"/>
            <filter string="Customer" name="grp_partner" context="{'group_by': 'partner_id'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- Window Action: Return Cases -->
    <record id="action_returns_cases" model="ir.actions.act_window">
      <field name="name">Return Cases</field>
      <field name="res_model">trakka.return.case</field>
      <field name="view_mode">tree,form</field>
      <field name="search_view_id" ref="view_trakka_return_case_search"/>
      <field name="context">{}</field>
    </record>

    <!-- ========================= -->
    <!-- Policy: LIST + FORM       -->
    <!-- ========================= -->

    <record id="view_trakka_policy_tree" model="ir.ui.view">
      <field name="name">trakka.policy.tree</field>
      <field name="model">trakka.policy</field>
      <field name="arch" type="xml">
        <tree string="Policies">
          <field name="name"/>
          <field name="active"/>
          <field name="fee_type"/>
          <field name="fee_value"/>
          <field name="allow_overrides"/>
          <field name="company_id"/>
        </tree>
      </field>
    </record>

    <record id="view_trakka_policy_form" model="ir.ui.view">
      <field name="name">trakka.policy.form</field>
      <field name="model">trakka.policy</field>
      <field name="arch" type="xml">
        <form string="Policy">
          <sheet>
            <group>
              <group>
                <field name="name"/>
                <field name="active"/>
                <field name="company_id"/>
                <field name="fee_type"/>
                <field name="fee_value"/>
                <field name="allow_overrides"/>
              </group>
              <group>
                <field name="notes"/>
              </group>
            </group>

            <notebook>
              <page string="Category Overrides">
                <field name="override_ids" context="{'default_policy_id': active_id}">
                  <tree editable="bottom">
                    <field name="category_id"/>
                    <field name="fee_type"/>
                    <field name="fee_value"/>
                    <field name="apply_allow_overrides"/>
                    <!-- show allow_overrides only when apply_allow_overrides true -->
                    <field name="allow_overrides" invisible="not apply_allow_overrides"/>
                  </tree>
                </field>
              </page>
            </notebook>
          </sheet>
        </form>
      </field>
    </record>

    <!-- Search view for Policies -->
    <record id="view_trakka_policy_search" model="ir.ui.view">
      <field name="name">trakka.policy.search</field>
      <field name="model">trakka.policy</field>
      <field name="arch" type="xml">
        <search string="Search Policies">
          <field name="name"/>
          <filter string="Active" name="active_true" domain="[('active','=',True)]"/>
          <filter string="Inactive" name="active_false" domain="[('active','=',False)]"/>
          <group expand="0" string="Group By">
            <filter string="Company" name="grp_company" context="{'group_by': 'company_id'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- Window Action: Policies -->
    <record id="action_returns_policies" model="ir.actions.act_window">
      <field name="name">Policies</field>
      <field name="res_model">trakka.policy</field>
      <field name="view_mode">tree,form</field>
      <field name="search_view_id" ref="view_trakka_policy_search"/>
      <field name="context">{}</field>
    </record>

  </data>
</odoo>
