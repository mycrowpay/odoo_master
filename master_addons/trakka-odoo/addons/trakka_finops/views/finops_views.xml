<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>

    <!-- ===================================================== -->
    <!-- Escrow: LIST + FORM + SEARCH                          -->
    <!-- ===================================================== -->

    <record id="view_trakka_escrow_tree" model="ir.ui.view">
      <field name="name">trakka.payguard.escrow.tree</field>
      <field name="model">trakka.payguard.escrow</field>
      <field name="arch" type="xml">
        <tree string="Escrows">
          <field name="name"/>
          <field name="state"/>
          <field name="sale_order_id"/>
          <field name="partner_id"/>
          <field name="amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
          <field name="currency_id"/>
          <field name="mpesa_ref"/>
          <field name="settlement_move_id"/>
          <field name="wallet_move_id"/>
          <field name="settlement_batch_id"/>
          <field name="company_id"/>
          <field name="create_date"/>
        </tree>
      </field>
    </record>

    <record id="view_trakka_escrow_form" model="ir.ui.view">
      <field name="name">trakka.payguard.escrow.form</field>
      <field name="model">trakka.payguard.escrow</field>
      <field name="priority">99</field>
      <field name="arch" type="xml">
        <form string="Escrow">
          <!-- expose 'state' for header widgets -->
          <field name="state" invisible="1"/>

          <header>
            <button name="action_mark_released_ready"
                    type="object"
                    string="Mark Release Ready"
                    class="oe_highlight"
                    invisible="not id or state != 'held'"/>
            <button name="action_post_settlement_move"
                    type="object"
                    string="Post Settlement Move"
                    invisible="not id or state != 'released_ready'"/>
            <field name="state"
                   widget="statusbar"
                   statusbar_visible="held,released_ready,released,refunded_partial,refunded_full"/>
          </header>

          <sheet>
            <group>
              <group>
                <field name="name" readonly="1"/>
                <field name="company_id"/>
                <!-- Pass company in context, allow SOs in any allowed company -->
                <field name="sale_order_id"
                       context="{'company_id': company_id, 'default_company_id': company_id}"
                       domain="[('company_id', 'in', allowed_company_ids)]"/>
                <field name="partner_id" readonly="1"/>
                <field name="amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                <field name="currency_id"/>
                <field name="mpesa_ref"/>
                <field name="idempotency_key"/>
              </group>
              <group string="Settlement Artifacts">
                <field name="settlement_move_id" readonly="1"/>
                <field name="wallet_move_id" readonly="1"/>
                <field name="settlement_batch_id" readonly="1"/>
              </group>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <record id="view_trakka_escrow_search" model="ir.ui.view">
      <field name="name">trakka.payguard.escrow.search</field>
      <field name="model">trakka.payguard.escrow</field>
      <field name="arch" type="xml">
        <search string="Search Escrows">
          <field name="name"/>
          <field name="sale_order_id"/>
          <field name="partner_id"/>
          <filter string="Held" name="state_held" domain="[('state','=','held')]"/>
          <filter string="Release Ready" name="state_ready" domain="[('state','=','released_ready')]"/>
          <filter string="Released" name="state_released" domain="[('state','=','released')]"/>
          <group expand="0" string="Group By">
            <filter string="State" name="grp_state" context="{'group_by': 'state'}"/>
            <filter string="Customer" name="grp_partner" context="{'group_by': 'partner_id'}"/>
            <filter string="Company" name="grp_company" context="{'group_by': 'company_id'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- ===================================================== -->
    <!-- Wallet: LIST + FORM                                    -->
    <!-- ===================================================== -->

    <record id="view_trakka_wallet_tree" model="ir.ui.view">
      <field name="name">trakka.wallet.tree</field>
      <field name="model">trakka.wallet</field>
      <field name="arch" type="xml">
        <tree string="Wallets">
          <field name="name"/>
          <field name="partner_id"/>
          <field name="balance" widget="monetary" options="{'currency_field': 'currency_id'}"/>
          <field name="currency_id"/>
          <field name="company_id"/>
        </tree>
      </field>
    </record>

    <record id="view_trakka_wallet_form" model="ir.ui.view">
      <field name="name">trakka.wallet.form</field>
      <field name="model">trakka.wallet</field>
      <field name="arch" type="xml">
        <form string="Wallet">
          <sheet>
            <group>
              <group>
                <field name="name" readonly="1"/>
                <field name="company_id"/>
                <field name="partner_id"/>
                <field name="currency_id"/>
                <field name="balance" readonly="1" widget="monetary" options="{'currency_field': 'currency_id'}"/>
              </group>
              <group string="Moves">
                <!-- For O2M, Odoo auto-sets default wallet_id; no need for deprecated active_id in context -->
                <field name="move_ids">
                  <tree editable="bottom">
                    <field name="name"/>
                    <field name="date"/>
                    <field name="amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                    <field name="currency_id"/>
                    <field name="move_type"/>
                    <field name="related_move_id"/>
                    <!-- keep company_id available for domains -->
                    <field name="company_id" column_invisible="1"/>
                  </tree>
                </field>
              </group>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <!-- ===================================================== -->
    <!-- Wallet Move: LIST + FORM                               -->
    <!-- ===================================================== -->

    <record id="view_trakka_wallet_move_tree" model="ir.ui.view">
      <field name="name">trakka.wallet.move.tree</field>
      <field name="model">trakka.wallet.move</field>
      <field name="arch" type="xml">
        <tree string="Wallet Moves">
          <field name="name"/>
          <field name="wallet_id"/>
          <field name="date"/>
          <field name="amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
          <field name="currency_id"/>
          <field name="move_type"/>
          <field name="related_move_id"/>
          <field name="company_id"/>
        </tree>
      </field>
    </record>

    <record id="view_trakka_wallet_move_form" model="ir.ui.view">
      <field name="name">trakka.wallet.move.form</field>
      <field name="model">trakka.wallet.move</field>
      <field name="arch" type="xml">
        <form string="Wallet Move">
          <!-- Ensure company_id is present for domain validation -->
          <field name="company_id" invisible="1"/>

          <sheet>
            <group>
              <group>
                <field name="name"/>
                <field name="wallet_id"/>
                <field name="date"/>
                <field name="amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                <field name="currency_id"/>
                <field name="move_type"/>
              </group>
              <group>
                <field name="related_move_id"/>
                <field name="ref"/>
              </group>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <!-- ===================================================== -->
    <!-- Settlement Batch: LIST + FORM                          -->
    <!-- ===================================================== -->

    <record id="view_trakka_settlement_batch_tree" model="ir.ui.view">
      <field name="name">trakka.settlement.batch.tree</field>
      <field name="model">trakka.settlement.batch</field>
      <field name="arch" type="xml">
        <tree string="Settlement Batches">
          <field name="name"/>
          <field name="date"/>
          <field name="state"/>
          <field name="company_id"/>
        </tree>
      </field>
    </record>

    <record id="view_trakka_settlement_batch_form" model="ir.ui.view">
      <field name="name">trakka.settlement.batch.form</field>
      <field name="model">trakka.settlement.batch</field>
      <field name="arch" type="xml">
        <form string="Settlement Batch">
          <field name="state" invisible="1"/>
          <sheet>
            <group>
              <group>
                <field name="name" readonly="1"/>
                <field name="company_id"/>
                <field name="date"/>
                <field name="state" readonly="1"/>
              </group>
              <group string="Items">
                <!-- No deprecated active_id needed; O2M will apply correct default -->
                <field name="escrow_ids">
                  <tree editable="bottom">
                    <field name="name"/>
                    <field name="sale_order_id"/>
                    <field name="partner_id"/>
                    <field name="amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                    <field name="currency_id"/>
                    <field name="state"/>
                  </tree>
                </field>
              </group>
            </group>
          </sheet>
        </form>
      </field>
    </record>

  </data>
</odoo>
